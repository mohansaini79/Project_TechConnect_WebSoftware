<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SyncSpace Collaborative Project Management</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <link
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --secondary: #8b5cf6;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --bg-light: #f9fafb;
        --bg-dark: #1f2937;
        --text-light: #111827;
        --text-dark: #f9fafb;
      }

      /* Dark Mode */
      body.dark-mode {
        background: var(--bg-dark);
        color: var(--text-dark);
      }

      body.dark-mode .bg-white {
        background: #374151 !important;
      }
      body.dark-mode .text-gray-800 {
        color: #f9fafb !important;
      }
      body.dark-mode .text-gray-600 {
        color: #d1d5db !important;
      }
      body.dark-mode .border-gray-300 {
        border-color: #4b5563 !important;
      }
      body.dark-mode .bg-gray-50 {
        background: #1f2937 !important;
      }
      body.dark-mode .bg-gray-100 {
        background: #374151 !important;
      }

      /* Smooth Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, var(--primary), var(--secondary));
        border-radius: 10px;
      }
      ::-webkit-scrollbar-track {
        background: #e5e7eb;
      }
      body.dark-mode ::-webkit-scrollbar-track {
        background: #374151;
      }

      /* Sidebar - Responsive */
      .sidebar {
        transition: transform 0.3s ease-in-out;
      }

      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          left: 0;
          top: 64px;
          height: calc(100vh - 64px);
          transform: translateX(-100%);
          z-index: 40;
          width: 80%;
          max-width: 280px;
        }

        .sidebar.active {
          transform: translateX(0);
        }

        .sidebar-overlay {
          display: none;
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 35;
        }

        .sidebar-overlay.active {
          display: block;
        }
      }

      /* Sidebar Active State */
      .sidebar-active {
        background: linear-gradient(
          90deg,
          rgba(99, 102, 241, 0.1),
          rgba(139, 92, 246, 0.05)
        );
        border-left: 4px solid var(--primary);
        color: var(--primary);
        font-weight: 600;
      }

      /* Task Cards */
      .task-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: grab;
        border: 2px solid transparent;
      }

      .task-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px rgba(99, 102, 241, 0.15);
        border-color: var(--primary);
      }

      .task-card.dragging {
        opacity: 0.5;
        transform: rotate(5deg);
      }

      .task-card:active {
        cursor: grabbing;
      }

      /* Kanban Columns - Responsive */
      .kanban-column {
        min-width: 280px;
        max-width: 350px;
        max-height: 600px;
        overflow-y: auto;
      }

      @media (max-width: 640px) {
        .kanban-column {
          min-width: 260px;
          max-width: 100%;
        }
      }

      /* Editor */
      #editor-container {
        height: 500px;
        border-radius: 8px;
      }

      @media (max-width: 768px) {
        #editor-container {
          height: 350px;
        }
      }

      /* Priority Badges with gradients */
      .priority-high {
        background: linear-gradient(135deg, #fecaca, #fca5a5);
        color: #991b1b;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 12px;
      }
      .priority-medium {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #92400e;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 12px;
      }
      .priority-low {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1e40af;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 12px;
      }

      /* Enhanced Animations */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes scaleIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .animate-slide {
        animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .animate-fade {
        animation: fadeIn 0.3s ease;
      }
      .animate-scale {
        animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Online Status Pulse */
      .online-dot {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 12px;
        height: 12px;
        background: var(--success);
        border: 2px solid white;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* Typing Indicator */
      .typing-indicator span {
        animation: typing 1.4s infinite;
        opacity: 0.3;
      }
      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          opacity: 0.3;
        }
        30% {
          opacity: 1;
        }
      }

      /* Loading Spinner with gradient */
      .spinner {
        border: 4px solid rgba(99, 102, 241, 0.2);
        border-top-color: var(--primary);
        border-right-color: var(--secondary);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Card Hover Effects */
      .card-hover {
        transition: all 0.3s ease;
      }

      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      /* Button Ripple Effect */
      button,
      .btn {
        position: relative;
        overflow: hidden;
      }

      button::after,
      .btn::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }

      button:active::after,
      .btn:active::after {
        width: 300px;
        height: 300px;
      }

      /* Responsive Modal */
      @media (max-width: 640px) {
        .modal-content {
          width: 95% !important;
          max-width: 95% !important;
          max-height: 90vh;
          overflow-y: auto;
          margin: 0 auto;
        }
      }

      /* File Preview Modal */
      .file-preview-modal {
        backdrop-filter: blur(8px);
      }

      /* Stats Cards Gradient */
      .stat-card {
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.1) 0%,
          transparent 70%
        );
        animation: rotate 20s linear infinite;
      }

      @keyframes rotate {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* Mobile Navigation */
      .mobile-menu-btn {
        display: none;
      }

      @media (max-width: 768px) {
        .mobile-menu-btn {
          display: block;
        }

        .desktop-only {
          display: none !important;
        }
      }

      /* Toast Notification Enhancement */
      .toast {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 100;
        animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* Responsive Grid */
      @media (max-width: 1024px) {
        .lg\:grid-cols-4 {
          grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        }

        .lg\:grid-cols-3 {
          grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        }
      }

      @media (max-width: 640px) {
        .md\:grid-cols-2,
        .lg\:grid-cols-3,
        .lg\:grid-cols-4 {
          grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
        }
      }

      /* Better Focus States */
      input:focus,
      select:focus,
      textarea:focus,
      button:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
      }

      /* Smooth Page Transitions */
      .section {
        animation: fadeIn 0.5s ease;
      }
    </style>
  </head>
  <body class="bg-gray-50 transition-colors duration-200">
    <!-- ==================== LOADING SCREEN ==================== -->
    <div
      id="loading-screen"
      class="hidden fixed inset-0 bg-white dark:bg-gray-900 flex items-center justify-center z-50"
    >
      <div class="text-center">
        <div class="spinner mx-auto mb-4"></div>
        <p class="text-gray-600 dark:text-gray-300">Loading...</p>
      </div>
    </div>

    <!-- ==================== AUTH SECTION ==================== -->
    <div
      id="auth-section"
      class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 p-4"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 p-8 animate-scale"
      >
        <div class="text-center mb-8">
          <h1
            class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2"
          >
            SyncSpace
          </h1>
          <p class="text-gray-600 text-sm md:text-base">
            Collaborative Project Management
          </p>
        </div>

        <!-- Login Form -->
        <div id="login-form">
          <h2 class="text-2xl font-semibold mb-6 text-gray-800">
            Welcome Back
          </h2>
          <form onsubmit="handleLogin(event)">
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2 text-gray-700"
                >Email</label
              >
              <input
                id="login-email"
                type="email"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="you@example.com"
              />
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2 text-gray-700"
                >Password</label
              >
              <input
                id="login-password"
                type="password"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="••••••••"
              />
            </div>
            <div class="mb-6 text-right">
              <button
                type="button"
                onclick="showForgotPassword()"
                class="text-sm text-indigo-600 hover:underline"
              >
                Forgot password?
              </button>
            </div>
            <button
              type="submit"
              class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition font-semibold"
            >
              Login
            </button>
          </form>
          <p class="text-center mt-4 text-gray-600 text-sm">
            Don't have an account?
            <button
              onclick="toggleAuth('register')"
              class="text-indigo-600 font-semibold hover:underline"
            >
              Register
            </button>
          </p>
        </div>

        <!-- Register Form -->
        <div id="register-form" class="hidden">
          <h2 class="text-2xl font-semibold mb-6 text-gray-800">
            Create Account
          </h2>
          <form onsubmit="handleRegister(event)">
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2 text-gray-700"
                >Full Name</label
              >
              <input
                id="register-name"
                type="text"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="John Doe"
              />
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2 text-gray-700"
                >Email</label
              >
              <input
                id="register-email"
                type="email"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="you@example.com"
              />
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2 text-gray-700"
                >Password</label
              >
              <input
                id="register-password"
                type="password"
                required
                minlength="6"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="Min. 6 characters"
              />
            </div>
            <div class="mb-6">
              <label class="block text-sm font-medium mb-2 text-gray-700"
                >Role</label
              >
              <select
                id="register-role"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
              >
                <option value="member">Member</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <button
              type="submit"
              class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition font-semibold"
            >
              Register
            </button>
          </form>
          <p class="text-center mt-4 text-gray-600 text-sm">
            Already have an account?
            <button
              onclick="toggleAuth('login')"
              class="text-indigo-600 font-semibold hover:underline"
            >
              Login
            </button>
          </p>
        </div>

        <!-- Forgot Password Form -->
        <div id="forgot-password-form" class="hidden">
          <h2 class="text-2xl font-semibold mb-6 text-gray-800">
            Reset Password
          </h2>
          <form onsubmit="handleForgotPassword(event)">
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2 text-gray-700"
                >Email</label
              >
              <input
                id="forgot-email"
                type="email"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="you@example.com"
              />
            </div>
            <button
              type="submit"
              class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition font-semibold"
            >
              Send Reset Link
            </button>
          </form>
          <p class="text-center mt-4 text-gray-600 text-sm">
            <button
              onclick="toggleAuth('login')"
              class="text-indigo-600 font-semibold hover:underline"
            >
              Back to Login
            </button>
          </p>
        </div>

        <!-- Error Display -->
        <div
          id="auth-error"
          class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg hidden text-sm"
        ></div>
        <div
          id="auth-success"
          class="mt-4 p-3 bg-green-100 text-green-700 rounded-lg hidden text-sm"
        ></div>
      </div>
    </div>

    <!-- ==================== MAIN APP ==================== -->
    <div id="app-section" class="hidden">
      <!-- Top Navbar -->
      <nav
        class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50 transition-colors"
      >
        <div class="max-w-full mx-auto px-4 md:px-6">
          <div class="flex justify-between h-16">
            <div class="flex items-center space-x-2 md:space-x-4">
              <!-- Mobile Menu Button -->
              <button
                onclick="toggleMobileSidebar()"
                class="mobile-menu-btn p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition"
              >
                <svg
                  class="w-6 h-6 text-gray-600 dark:text-gray-300"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 12h16M4 18h16"
                  ></path>
                </svg>
              </button>

              <h1
                class="text-xl md:text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent"
              >
                SyncSpace
              </h1>

              <!-- Global Search -->
              <div class="relative hidden md:block">
                <input
                  id="global-search"
                  type="text"
                  placeholder="Search..."
                  class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white w-48 lg:w-64"
                  oninput="globalSearch(this.value)"
                />
                <i
                  class="fas fa-search absolute left-3 top-3 text-gray-400"
                ></i>
                <div
                  id="search-results"
                  class="hidden absolute top-full mt-2 w-full bg-white dark:bg-gray-700 rounded-lg shadow-xl border dark:border-gray-600 max-h-96 overflow-y-auto"
                ></div>
              </div>
            </div>

            <div class="flex items-center space-x-2 md:space-x-4">
              <!-- Theme Toggle -->
              <button
                onclick="toggleTheme()"
                class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition"
              >
                <i
                  id="theme-icon"
                  class="fas fa-moon text-gray-600 dark:text-gray-300 text-lg"
                ></i>
              </button>

              <!-- Notifications -->
              <div class="relative">
                <button
                  onclick="toggleNotifications()"
                  class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 relative transition"
                >
                  <i
                    class="fas fa-bell text-gray-600 dark:text-gray-300 text-lg"
                  ></i>
                  <span
                    id="notif-badge"
                    class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-semibold"
                    >0</span
                  >
                </button>
                <div
                  id="notif-dropdown"
                  class="hidden absolute right-0 mt-2 w-80 md:w-96 bg-white dark:bg-gray-700 rounded-lg shadow-xl border dark:border-gray-600 max-h-96 overflow-y-auto"
                >
                  <div
                    class="p-4 border-b dark:border-gray-600 flex justify-between items-center"
                  >
                    <h3 class="font-semibold text-gray-800 dark:text-white">
                      Notifications
                    </h3>
                    <button
                      onclick="markAllNotificationsRead()"
                      class="text-xs text-indigo-600 hover:underline"
                    >
                      Mark all read
                    </button>
                  </div>
                  <div id="notif-list"></div>
                </div>
              </div>

              <!-- User Menu -->
              <div class="relative">
                <button
                  onclick="toggleUserMenu()"
                  class="flex items-center space-x-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-2 transition"
                >
                  <div class="relative">
                    <img
                      id="user-avatar-img"
                      src=""
                      alt=""
                      class="hidden h-8 w-8 md:h-10 md:w-10 rounded-full object-cover"
                    />
                    <div
                      id="user-avatar-text"
                      class="bg-indigo-600 text-white rounded-full h-8 w-8 md:h-10 md:w-10 flex items-center justify-center font-semibold text-sm md:text-base"
                    ></div>
                  </div>
                  <span
                    id="user-name"
                    class="font-medium text-gray-700 dark:text-gray-200 hidden md:block text-sm"
                  ></span>
                  <i
                    class="fas fa-chevron-down text-gray-400 text-sm hidden md:block"
                  ></i>
                </button>

                <!-- User Dropdown -->
                <div
                  id="user-menu"
                  class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-700 rounded-lg shadow-xl border dark:border-gray-600"
                >
                  <button
                    onclick="openModal('profile-modal')"
                    class="w-full text-left px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-600 flex items-center space-x-2 text-sm"
                  >
                    <i class="fas fa-user text-gray-600 dark:text-gray-300"></i>
                    <span class="dark:text-white">Profile Settings</span>
                  </button>
                  <button
                    onclick="logout()"
                    class="w-full text-left px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-600 text-red-600 dark:text-red-400 flex items-center space-x-2 text-sm"
                  >
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>

      <div class="flex">
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

        <!-- Sidebar -->
        <aside
          class="sidebar w-64 bg-white dark:bg-gray-800 min-h-screen shadow-lg sticky top-16 transition-colors"
        >
          <div class="p-4 space-y-1">
            <button
              onclick="showSection('dashboard')"
              class="nav-link sidebar-active w-full text-left px-4 py-3 rounded-lg flex items-center transition hover:bg-gray-50 dark:hover:bg-gray-700"
            >
              <i class="fas fa-home mr-3 text-lg"></i>
              <span class="dark:text-white">Dashboard</span>
            </button>
            <button
              onclick="showSection('teams')"
              class="nav-link w-full text-left px-4 py-3 rounded-lg flex items-center transition hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-300"
            >
              <i class="fas fa-users mr-3 text-lg"></i>
              <span>Teams</span>
            </button>
            <button
              onclick="showSection('workspaces')"
              class="nav-link w-full text-left px-4 py-3 rounded-lg flex items-center transition hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-300"
            >
              <i class="fas fa-briefcase mr-3 text-lg"></i>
              <span>Workspaces</span>
            </button>
            <button
              onclick="showSection('kanban')"
              class="nav-link w-full text-left px-4 py-3 rounded-lg flex items-center transition hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-300"
            >
              <i class="fas fa-columns mr-3 text-lg"></i>
              <span>Kanban Board</span>
            </button>
            <button
              onclick="showSection('documents')"
              class="nav-link w-full text-left px-4 py-3 rounded-lg flex items-center transition hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-300"
            >
              <i class="fas fa-file-alt mr-3 text-lg"></i>
              <span>Documents</span>
            </button>
            <button
              onclick="showSection('files')"
              class="nav-link w-full text-left px-4 py-3 rounded-lg flex items-center transition hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-300"
            >
              <i class="fas fa-folder mr-3 text-lg"></i>
              <span>Files</span>
            </button>
            <button
              onclick="showSection('chat')"
              class="nav-link w-full text-left px-4 py-3 rounded-lg flex items-center transition hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-300"
            >
              <i class="fas fa-comments mr-3 text-lg"></i>
              <span>Team Chat</span>
            </button>
            <button
              onclick="showSection('activities')"
              class="nav-link w-full text-left px-4 py-3 rounded-lg flex items-center transition hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-300"
            >
              <i class="fas fa-history mr-3 text-lg"></i>
              <span>Activities</span>
            </button>
          </div>
        </aside>

        <!-- Main Content Area -->
        <main
          class="flex-1 p-4 md:p-8 bg-gray-50 dark:bg-gray-900 transition-colors"
        >
          <!-- Dashboard Section -->
          <div id="dashboard-section" class="section">
            <h2
              class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-6"
            >
              Dashboard
            </h2>

            <!-- Stats Cards -->
            <div
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8"
            >
              <div
                class="stat-card bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition card-hover"
              >
                <div class="flex items-center justify-between relative z-10">
                  <div>
                    <p class="text-blue-100 text-sm">Total Users</p>
                    <h3
                      id="stat-users"
                      class="text-3xl md:text-4xl font-bold mt-2"
                    >
                      0
                    </h3>
                  </div>
                  <i class="fas fa-users text-4xl md:text-5xl opacity-30"></i>
                </div>
              </div>
              <div
                class="stat-card bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition card-hover"
              >
                <div class="flex items-center justify-between relative z-10">
                  <div>
                    <p class="text-green-100 text-sm">My Teams</p>
                    <h3
                      id="stat-teams"
                      class="text-3xl md:text-4xl font-bold mt-2"
                    >
                      0
                    </h3>
                  </div>
                  <i
                    class="fas fa-user-friends text-4xl md:text-5xl opacity-30"
                  ></i>
                </div>
              </div>
              <div
                class="stat-card bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition card-hover"
              >
                <div class="flex items-center justify-between relative z-10">
                  <div>
                    <p class="text-purple-100 text-sm">Workspaces</p>
                    <h3
                      id="stat-workspaces"
                      class="text-3xl md:text-4xl font-bold mt-2"
                    >
                      0
                    </h3>
                  </div>
                  <i
                    class="fas fa-briefcase text-4xl md:text-5xl opacity-30"
                  ></i>
                </div>
              </div>
              <div
                class="stat-card bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition card-hover"
              >
                <div class="flex items-center justify-between relative z-10">
                  <div>
                    <p class="text-orange-100 text-sm">Total Files</p>
                    <h3
                      id="stat-files"
                      class="text-3xl md:text-4xl font-bold mt-2"
                    >
                      0
                    </h3>
                  </div>
                  <i class="fas fa-folder text-4xl md:text-5xl opacity-30"></i>
                </div>
              </div>
            </div>

            <!-- Task Stats -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-8">
              <div
                class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 card-hover"
              >
                <h3
                  class="text-lg md:text-xl font-semibold text-gray-800 dark:text-white mb-4"
                >
                  Task Overview
                </h3>
                <div class="space-y-3">
                  <div class="flex justify-between items-center">
                    <span
                      class="text-sm md:text-base text-gray-600 dark:text-gray-300"
                      >Pending Tasks</span
                    >
                    <span
                      id="pending-tasks"
                      class="text-xl md:text-2xl font-bold text-orange-600"
                      >0</span
                    >
                  </div>
                  <div class="flex justify-between items-center">
                    <span
                      class="text-sm md:text-base text-gray-600 dark:text-gray-300"
                      >Completed Tasks</span
                    >
                    <span
                      id="completed-tasks"
                      class="text-xl md:text-2xl font-bold text-green-600"
                      >0</span
                    >
                  </div>
                  <div class="flex justify-between items-center">
                    <span
                      class="text-sm md:text-base text-gray-600 dark:text-gray-300"
                      >Total Tasks</span
                    >
                    <span
                      id="total-tasks"
                      class="text-xl md:text-2xl font-bold text-indigo-600"
                      >0</span
                    >
                  </div>
                </div>
              </div>

              <div
                class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 card-hover"
              >
                <h3
                  class="text-lg md:text-xl font-semibold text-gray-800 dark:text-white mb-4"
                >
                  Recent Activity
                </h3>
                <div
                  id="dashboard-activities"
                  class="space-y-2 max-h-48 overflow-y-auto"
                >
                  <p class="text-gray-500 dark:text-gray-400 text-sm">
                    No recent activity
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Teams Section -->
          <div id="teams-section" class="section hidden">
            <div
              class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4"
            >
              <h2
                class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white"
              >
                Teams
              </h2>
              <button
                onclick="openModal('create-team-modal')"
                class="w-full md:w-auto px-4 py-2 md:px-6 md:py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:from-indigo-700 hover:to-purple-700 transition shadow-lg text-sm md:text-base"
              >
                <i class="fas fa-plus mr-2"></i>Create Team
              </button>
            </div>
            <div
              id="teams-list"
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"
            ></div>
          </div>

          <!-- Workspaces Section -->
          <div id="workspaces-section" class="section hidden">
            <div
              class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4"
            >
              <h2
                class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white"
              >
                Workspaces
              </h2>
              <button
                onclick="openModal('create-workspace-modal')"
                class="w-full md:w-auto px-4 py-2 md:px-6 md:py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:from-indigo-700 hover:to-purple-700 transition shadow-lg text-sm md:text-base"
              >
                <i class="fas fa-plus mr-2"></i>Create Workspace
              </button>
            </div>
            <div
              id="workspaces-list"
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"
            ></div>
          </div>

          <!-- Kanban Section -->
          <div id="kanban-section" class="section hidden">
            <div
              class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4"
            >
              <h2
                class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white"
              >
                Kanban Board
              </h2>
              <div
                class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 w-full md:w-auto"
              >
                <select
                  id="kanban-workspace"
                  onchange="loadKanban()"
                  class="w-full sm:w-auto px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white text-sm"
                >
                  <option value="">Select Workspace</option>
                </select>
                <button
                  onclick="addColumn()"
                  class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm"
                >
                  <i class="fas fa-plus mr-1"></i>Add Column
                </button>
              </div>
            </div>
            <div
              id="kanban-board"
              class="flex space-x-4 overflow-x-auto pb-4"
            ></div>
          </div>

          <!-- Documents Section -->
          <div id="documents-section" class="section hidden">
            <div
              class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4"
            >
              <h2
                class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white"
              >
                Document Editor
              </h2>
              <div
                class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 w-full md:w-auto"
              >
                <select
                  id="doc-workspace"
                  onchange="loadDocument()"
                  class="w-full sm:w-auto px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white text-sm"
                >
                  <option value="">Select Workspace</option>
                </select>
                <button
                  onclick="openModal('doc-versions-modal')"
                  class="w-full sm:w-auto px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition text-sm"
                >
                  <i class="fas fa-history mr-1"></i>Versions
                </button>
              </div>
            </div>
            <div
              class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 md:p-6"
            >
              <div
                id="active-editors"
                class="mb-4 flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-300"
              >
                <i class="fas fa-circle text-green-500 animate-pulse"></i>
                <span>Active editors: <span id="editor-count">0</span></span>
              </div>
              <div id="editor-container" class="dark:bg-gray-700"></div>
              <div
                class="mt-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3"
              >
                <span
                  class="text-sm text-gray-500 dark:text-gray-400"
                  id="doc-status"
                  >Auto-save enabled</span
                >
                <button
                  onclick="saveDocument()"
                  class="w-full sm:w-auto px-4 py-2 md:px-6 md:py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm md:text-base"
                >
                  <i class="fas fa-save mr-2"></i>Save Document
                </button>
              </div>
            </div>
          </div>

          <!-- Files Section -->
          <div id="files-section" class="section hidden">
            <div
              class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4"
            >
              <h2
                class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white"
              >
                Files
              </h2>
              <div
                class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 w-full md:w-auto"
              >
                <select
                  id="files-workspace"
                  onchange="loadFiles()"
                  class="w-full sm:w-auto px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white text-sm"
                >
                  <option value="">Select Workspace</option>
                </select>
                <button
                  onclick="openModal('upload-modal')"
                  class="w-full sm:w-auto px-4 py-2 md:px-6 md:py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm md:text-base"
                >
                  <i class="fas fa-upload mr-2"></i>Upload File
                </button>
              </div>
            </div>
            <div
              id="files-list"
              class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6"
            ></div>
          </div>

          <!-- Chat Section -->
          <div id="chat-section" class="section hidden">
            <div
              class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4"
            >
              <h2
                class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white"
              >
                Team Chat
              </h2>
              <div
                class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 w-full md:w-auto"
              >
                <div
                  id="online-users-display"
                  class="text-sm text-gray-600 dark:text-gray-300"
                >
                  <i class="fas fa-circle text-green-500"></i>
                  <span id="online-count">0</span> online
                </div>
                <select
                  id="chat-workspace"
                  onchange="joinChat()"
                  class="w-full sm:w-auto px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white text-sm"
                >
                  <option value="">Select Workspace</option>
                </select>
              </div>
            </div>
            <div
              class="bg-white dark:bg-gray-800 rounded-lg shadow-lg h-[500px] md:h-[600px] flex flex-col"
            >
              <div
                id="chat-messages"
                class="flex-1 p-4 md:p-6 overflow-y-auto bg-gray-50 dark:bg-gray-900"
              ></div>
              <div
                id="typing-indicator"
                class="hidden px-4 md:px-6 py-2 text-sm text-gray-500 dark:text-gray-400"
              >
                <span class="typing-indicator">
                  <span>•</span><span>•</span><span>•</span>
                </span>
                <span id="typing-user"></span> is typing...
              </div>
              <div
                class="border-t dark:border-gray-700 p-3 md:p-4 bg-white dark:bg-gray-800"
              >
                <form onsubmit="sendMessage(event)" class="flex space-x-2">
                  <input
                    id="chat-input"
                    type="text"
                    placeholder="Type your message..."
                    class="flex-1 px-3 py-2 md:px-4 md:py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white text-sm"
                    oninput="handleTyping()"
                  />
                  <button
                    type="submit"
                    class="px-4 py-2 md:px-6 md:py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
                  >
                    <i class="fas fa-paper-plane"></i>
                  </button>
                </form>
              </div>
            </div>
          </div>

          <!-- Activities Section -->
          <div id="activities-section" class="section hidden">
            <div
              class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4"
            >
              <h2
                class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white"
              >
                Activity Timeline
              </h2>
              <select
                id="activities-workspace"
                onchange="loadActivities()"
                class="w-full md:w-auto px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white text-sm"
              >
                <option value="">Select Workspace</option>
              </select>
            </div>
            <div
              class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 md:p-6"
            >
              <div id="activities-list" class="space-y-4"></div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- ==================== MODALS ==================== -->

    <!-- Create Team Modal -->
    <div
      id="create-team-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-4 p-6 md:p-8 animate-scale modal-content"
      >
        <h3
          class="text-xl md:text-2xl font-bold mb-6 text-gray-800 dark:text-white"
        >
          Create Team
        </h3>
        <form onsubmit="createTeam(event)">
          <div class="mb-4">
            <label
              class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300"
              >Team Name</label
            >
            <input
              id="team-name"
              type="text"
              required
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white text-sm"
              placeholder="Enter team name"
            />
          </div>
          <div class="mb-6">
            <label
              class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300"
              >Description (Optional)</label
            >
            <textarea
              id="team-description"
              rows="3"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white text-sm"
              placeholder="Team description"
            ></textarea>
          </div>
          <div
            class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3"
          >
            <button
              type="submit"
              class="flex-1 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition font-semibold text-sm"
            >
              Create
            </button>
            <button
              type="button"
              onclick="closeModal('create-team-modal')"
              class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 py-3 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition font-semibold text-sm"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Team Settings Modal -->
    <div
      id="team-settings-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl mx-4 p-6 md:p-8 animate-scale max-h-[90vh] overflow-y-auto modal-content"
      >
        <h3
          class="text-xl md:text-2xl font-bold mb-6 text-gray-800 dark:text-white"
        >
          Team Settings
        </h3>

        <!-- Team Info -->
        <div class="mb-6">
          <h4
            class="font-semibold text-base md:text-lg mb-3 text-gray-800 dark:text-white"
          >
            Team Information
          </h4>
          <div class="space-y-3">
            <div>
              <label
                class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300"
                >Team Name</label
              >
              <input
                id="edit-team-name"
                type="text"
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-sm"
              />
            </div>
            <div>
              <label
                class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300"
                >Description</label
              >
              <textarea
                id="edit-team-description"
                rows="3"
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-sm"
              ></textarea>
            </div>
          </div>
        </div>

        <!-- Team Members -->
        <div class="mb-6">
          <div class="flex justify-between items-center mb-3">
            <h4
              class="font-semibold text-base md:text-lg text-gray-800 dark:text-white"
            >
              Members
            </h4>
            <button
              onclick="openAddMemberModal()"
              class="text-sm text-indigo-600 hover:underline"
            >
              <i class="fas fa-plus mr-1"></i>Add Member
            </button>
          </div>
          <div id="team-members-list" class="space-y-2"></div>
        </div>

        <div
          class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3"
        >
          <button
            onclick="updateTeam()"
            class="flex-1 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition text-sm"
          >
            Save Changes
          </button>
          <button
            onclick="deleteTeam()"
            class="sm:w-auto px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm"
          >
            Delete Team
          </button>
          <button
            onclick="closeModal('team-settings-modal')"
            class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 py-3 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition text-sm"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Create Workspace Modal -->
    <div
      id="create-workspace-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-4 p-6 md:p-8 animate-scale modal-content"
      >
        <h3
          class="text-xl md:text-2xl font-bold mb-6 text-gray-800 dark:text-white"
        >
          Create Workspace
        </h3>
        <form onsubmit="createWorkspace(event)">
          <div class="mb-4">
            <label
              class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300"
              >Workspace Name</label
            >
            <input
              id="workspace-name"
              type="text"
              required
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white text-sm"
              placeholder="Enter workspace name"
            />
          </div>
          <div class="mb-4">
            <label
              class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300"
              >Select Team</label
            >
            <select
              id="workspace-team"
              required
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white text-sm"
            >
              <option value="">Choose a team</option>
            </select>
          </div>
          <div class="mb-6">
            <label
              class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300"
              >Description (Optional)</label
            >
            <textarea
              id="workspace-description"
              rows="3"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-sm"
              placeholder="Workspace description"
            ></textarea>
          </div>
          <div
            class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3"
          >
            <button
              type="submit"
              class="flex-1 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition font-semibold text-sm"
            >
              Create
            </button>
            <button
              type="button"
              onclick="closeModal('create-workspace-modal')"
              class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 py-3 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition font-semibold text-sm"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Task Modal -->
    <div
      id="edit-task-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl mx-4 p-6 md:p-8 animate-scale modal-content"
      >
        <h3
          class="text-xl md:text-2xl font-bold mb-6 text-gray-800 dark:text-white"
        >
          Edit Task
        </h3>
        <form onsubmit="updateTask(event)">
          <div class="mb-4">
            <label
              class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300"
              >Task Title</label
            >
            <input
              id="edit-task-title"
              type="text"
              required
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-sm"
            />
          </div>
          <div class="mb-4">
            <label
              class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300"
              >Description</label
            >
            <textarea
              id="edit-task-desc"
              rows="3"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-sm"
            ></textarea>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
            <div>
              <label
                class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300"
                >Priority</label
              >
              <select
                id="edit-task-priority"
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-sm"
              >
                <option value="">None</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
              </select>
            </div>
            <div>
              <label
                class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300"
                >Due Date</label
              >
              <input
                id="edit-task-due"
                type="date"
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-sm"
              />
            </div>
          </div>
          <div class="mb-6">
            <label
              class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300"
              >Assign To</label
            >
            <select
              id="edit-task-assigned"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-sm"
            >
              <option value="">Unassigned</option>
            </select>
          </div>
          <div
            class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3"
          >
            <button
              type="submit"
              class="flex-1 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition text-sm"
            >
              Save Changes
            </button>
            <button
              type="button"
              onclick="deleteCurrentTask()"
              class="sm:w-auto px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm"
            >
              Delete
            </button>
            <button
              type="button"
              onclick="closeModal('edit-task-modal')"
              class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 py-3 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition text-sm"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Task Comments Modal -->
    <div
      id="comments-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl mx-4 p-6 md:p-8 max-h-[80vh] overflow-y-auto animate-scale modal-content"
      >
        <h3
          class="text-xl md:text-2xl font-bold mb-4 text-gray-800 dark:text-white"
        >
          Task Comments
        </h3>
        <div
          id="comments-list"
          class="mb-4 max-h-60 md:max-h-96 overflow-y-auto space-y-3"
        ></div>
        <div
          class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4"
        >
          <input
            id="comment-input"
            type="text"
            placeholder="Add a comment..."
            class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white text-sm"
          />
          <button
            onclick="addComment()"
            class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm"
          >
            Add
          </button>
        </div>
        <button
          onclick="closeModal('comments-modal')"
          class="w-full bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 py-3 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition font-semibold text-sm"
        >
          Close
        </button>
      </div>
    </div>

    <!-- Upload File Modal -->
    <div
      id="upload-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-4 p-6 md:p-8 animate-scale modal-content"
      >
        <h3
          class="text-xl md:text-2xl font-bold mb-6 text-gray-800 dark:text-white"
        >
          Upload File
        </h3>
        <form onsubmit="uploadFile(event)">
          <div class="mb-4">
            <label
              class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300"
              >Select File (Max 10MB)</label
            >
            <input
              id="file-input"
              type="file"
              required
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-sm"
            />
          </div>
          <div
            class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3"
          >
            <button
              type="submit"
              class="flex-1 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition font-semibold text-sm"
            >
              Upload
            </button>
            <button
              type="button"
              onclick="closeModal('upload-modal')"
              class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 py-3 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition font-semibold text-sm"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- File Preview Modal -->
    <div
      id="file-preview-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 file-preview-modal p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden"
      >
        <div
          class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 border-b dark:border-gray-700 gap-3"
        >
          <h3
            id="preview-filename"
            class="text-lg md:text-xl font-bold text-gray-800 dark:text-white break-all"
          ></h3>
          <div class="flex space-x-2 w-full sm:w-auto">
            <a
              id="preview-download"
              href=""
              download
              class="flex-1 sm:flex-none text-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm"
            >
              <i class="fas fa-download mr-2"></i>Download
            </a>
            <button
              onclick="closeModal('file-preview-modal')"
              class="flex-1 sm:flex-none px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition text-sm"
            >
              Close
            </button>
          </div>
        </div>
        <div id="preview-content" class="p-4 overflow-auto max-h-[75vh]"></div>
      </div>
    </div>

    <!-- Document Versions Modal -->
    <div
      id="doc-versions-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl mx-4 p-6 md:p-8 animate-scale modal-content"
      >
        <h3
          class="text-xl md:text-2xl font-bold mb-6 text-gray-800 dark:text-white"
        >
          Document Version History
        </h3>
        <div
          id="versions-list"
          class="space-y-2 max-h-60 md:max-h-96 overflow-y-auto mb-4"
        ></div>
        <button
          onclick="closeModal('doc-versions-modal')"
          class="w-full bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 py-3 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition text-sm"
        >
          Close
        </button>
      </div>
    </div>

    <!-- Profile Settings Modal -->
    <div
      id="profile-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-4 p-6 md:p-8 animate-scale modal-content"
      >
        <h3
          class="text-xl md:text-2xl font-bold mb-6 text-gray-800 dark:text-white"
        >
          Profile Settings
        </h3>
        <form onsubmit="updateProfile(event)">
          <div class="mb-4 text-center">
            <div class="relative inline-block">
              <img
                id="profile-avatar-preview"
                src=""
                alt=""
                class="hidden h-20 w-20 md:h-24 md:w-24 rounded-full object-cover"
              />
              <div
                id="profile-avatar-text"
                class="bg-indigo-600 text-white rounded-full h-20 w-20 md:h-24 md:w-24 flex items-center justify-center text-2xl md:text-3xl font-semibold"
              ></div>
              <label
                for="avatar-upload"
                class="absolute bottom-0 right-0 bg-indigo-600 text-white rounded-full p-2 cursor-pointer hover:bg-indigo-700"
              >
                <i class="fas fa-camera"></i>
              </label>
              <input
                id="avatar-upload"
                type="file"
                accept="image/*"
                class="hidden"
                onchange="uploadAvatar(event)"
              />
            </div>
          </div>
          <div class="mb-4">
            <label
              class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300"
              >Name</label
            >
            <input
              id="profile-name"
              type="text"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-sm"
            />
          </div>
          <div class="mb-4">
            <label
              class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300"
              >Email</label
            >
            <input
              id="profile-email"
              type="email"
              disabled
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-600 dark:text-gray-300 text-sm"
            />
          </div>
          <div class="mb-6">
            <label
              class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300"
              >New Password (leave blank to keep current)</label
            >
            <input
              id="profile-password"
              type="password"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-sm"
              placeholder="New password"
            />
          </div>
          <div
            class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3"
          >
            <button
              type="submit"
              class="flex-1 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition font-semibold text-sm"
            >
              Save Changes
            </button>
            <button
              type="button"
              onclick="closeModal('profile-modal')"
              class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 py-3 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition font-semibold text-sm"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ==================== JAVASCRIPT ==================== -->
    <script>
      // ⚠️ apna backend URL
    const API_BASE_URL = 'https://project-techconnect-websoftware-1.onrender.com';

    let socket = null;
    let authToken = localStorage.getItem('authToken');
    let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    let currentWorkspaceId = null;
    let currentTeamId = null;
    let currentTaskId = null;
    let quillEditor = null;
    let draggedTask = null;
    let workspaceMembers = [];

document.addEventListener('DOMContentLoaded', () => {
      if (authToken && currentUser.id) {
        showApp();
        initializeApp();
      }
    });

    function toggleAuthForm() {
      document.getElementById('login-form').classList.toggle('hidden');
      document.getElementById('register-form').classList.toggle('hidden');
      document.getElementById('auth-error').classList.add('hidden');
    }

    async function handleLogin(event) {
      event.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      try {
        const res = await fetch(`${API_BASE_URL}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (!res.ok) {
          showError(data.msg || 'Login failed');
          return;
        }
        authToken = data.access_token;
        currentUser = data.user;
        localStorage.setItem('authToken', authToken);
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        showApp();
        initializeApp();
      } catch (e) {
        console.error(e);
        showError('Connection error');
      }
    }

    async function handleRegister(event) {
      event.preventDefault();
      const name = document.getElementById('register-name').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      const role = document.getElementById('register-role').value;
      try {
        const res = await fetch(`${API_BASE_URL}/api/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password, role })
        });
        const data = await res.json();
        if (!res.ok) {
          showError(data.msg || 'Registration failed');
          return;
        }
        authToken = data.access_token;
        currentUser = data.user;
        localStorage.setItem('authToken', authToken);
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        showApp();
        initializeApp();
      } catch (e) {
        console.error(e);
        showError('Connection error');
      }
    }

    function showError(msg) {
      const div = document.getElementById('auth-error');
      div.textContent = msg;
      div.classList.remove('hidden');
    }

    function showApp() {
      document.getElementById('auth-section').classList.add('hidden');
      document.getElementById('app-section').classList.remove('hidden');
      document.getElementById('user-avatar').textContent = currentUser.name?.charAt(0)?.toUpperCase() || '?';
      updateUIForRole();
    }

    function logout() {
      if (socket) socket.disconnect();
      localStorage.removeItem('authToken');
      localStorage.removeItem('currentUser');
      location.reload();
    }

    async function initializeApp() {
      if (!authToken) return;
      initializeSocket();
      initializeQuill();
      await loadDashboardStats();
      await loadTeams();
      await loadWorkspaces();
      await loadNotifications();
      populateWorkspaceSelects();
    }

    function initializeSocket() {
      socket = io(API_BASE_URL, { query: { token: authToken } });

      socket.on('connect', () => console.log('Socket connected'));

      socket.on('kanban_update', data => {
        if (data.workspace_id === currentWorkspaceId) loadKanban();
      });

      socket.on('doc_change', data => {
        if (data.user_name !== currentUser.name) quillEditor.updateContents(data.delta);
      });

      socket.on('user_typing', data => {
        const el = document.getElementById('typing-indicator');
        el.textContent = data.is_typing ? `${data.user_name} is typing...` : '';
      });

      socket.on('file_uploaded', data => {
        if (data.workspace_id === currentWorkspaceId) {
          loadFiles();
          showNotification(`File uploaded: ${data.name}`);
        }
      });

      socket.on('chat_history', data => {
        const div = document.getElementById('chat-messages');
        div.innerHTML = '';
        if (data.messages?.length) data.messages.forEach(displayChatMessage);
        else div.innerHTML = '<p class="text-gray-500 text-center">No messages</p>';
      });

      socket.on('chat_message', data => displayChatMessage(data));

      socket.on('task_comment_added', data => {
        if (data.workspace_id === currentWorkspaceId) showNotification('New comment added');
      });

      socket.on('task_assigned', data => {
        if (data.assigned_to === currentUser.id) {
          showNotification('You were assigned a task');
          loadNotifications();
        }
      });

      socket.on('notification', data => {
        showNotification(data.message);
        loadNotifications();
      });
    }

    function initializeQuill() {
      quillEditor = new Quill('#editor-container', {
        theme: 'snow',
        modules: {
          toolbar: [
            [{ header: [1, 2, 3, false] }],
            ['bold', 'italic', 'underline'],
            [{ list: 'ordered' }, { list: 'bullet' }],
            ['link'],
            ['clean']
          ]
        }
      });
      let typingTimeout;
      quillEditor.on('text-change', (delta, oldDelta, source) => {
        if (source !== 'user' || !currentWorkspaceId) return;
        socket.emit('doc_edit', {
          workspace_id: currentWorkspaceId,
          delta,
          user_name: currentUser.name
        });
        socket.emit('typing', {
          workspace_id: currentWorkspaceId,
          user_name: currentUser.name,
          is_typing: true
        });
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          socket.emit('typing', {
            workspace_id: currentWorkspaceId,
            user_name: currentUser.name,
            is_typing: false
          });
        }, 1000);
      });
    }

    function showNotification(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed top-20 right-4 bg-green-100 text-green-800 px-6 py-3 rounded-lg shadow-lg z-50 border border-green-300';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    async function loadNotifications() {
      try {
        const res = await fetch(`${API_BASE_URL}/api/notifications`, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        const data = await res.json();
        const badge = document.getElementById('notification-badge');
        if (data.unread_count > 0) {
          badge.textContent = data.unread_count;
          badge.classList.remove('hidden');
        } else badge.classList.add('hidden');
        const list = document.getElementById('notifications-list');
        list.innerHTML =
          data.notifications
            .map(
              n => `
              <div class="p-3 ${n.read ? 'bg-white' : 'bg-green-50'} hover:bg-gray-50 border-b">
                <p class="text-sm text-gray-800">${n.message}</p>
                <p class="text-xs text-gray-500 mt-1">${new Date(n.created_at).toLocaleString()}</p>
              </div>`
            )
            .join('') || '<p class="p-4 text-center text-gray-500">No notifications</p>';
      } catch (e) {
        console.error(e);
      }
    }

    function toggleNotifications() {
      document.getElementById('notifications-dropdown').classList.toggle('hidden');
    }

    function showSection(e, section) {
      document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
      document.getElementById(`${section}-section`).classList.remove('hidden');
      document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('sidebar-active'));
      if (e?.currentTarget) e.currentTarget.classList.add('sidebar-active');
      if (section === 'dashboard') loadDashboardStats();
      if (section === 'teams') loadTeams();
      if (section === 'workspaces') loadWorkspaces();
    }

    async function loadDashboardStats() {
      try {
        const res = await fetch(`${API_BASE_URL}/api/review`, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        const s = await res.json();
        document.getElementById('stat-users').textContent = s.users;
        document.getElementById('stat-teams').textContent = s.teams;
        document.getElementById('stat-workspaces').textContent = s.workspaces;
        document.getElementById('stat-files').textContent = s.files;
      } catch (e) {
        console.error(e);
      }
    }

    async function loadTeams() {
      try {
        const res = await fetch(`${API_BASE_URL}/api/teams`, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        const teams = await res.json();
        const list = document.getElementById('teams-list');
        list.innerHTML = teams
          .map(
            t => `
          <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
              <div class="bg-indigo-100 rounded-full p-3">
                <i class="fas fa-users text-indigo-600 text-2xl"></i>
              </div>
              <span class="px-3 py-1 text-xs rounded ${
                t.my_role === 'admin' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'
              }">${t.my_role}</span>
            </div>
            <h3 class="text-xl font-semibold mb-2">${t.name}</h3>
            <p class="text-sm text-gray-600 mb-4">${t.member_count} members</p>
            <div class="flex space-x-2">
              <button onclick="showTeamMembers('${t.id}')" class="flex-1 text-sm bg-indigo-600 text-white py-2 rounded">
                <i class="fas fa-users mr-1"></i>Members
              </button>
              ${
                t.owner === currentUser.id
                  ? `<button onclick="showCreateWorkspaceModalFromTeam('${t.id}')" class="flex-1 text-sm bg-green-600 text-white py-2 rounded">
                    <i class="fas fa-briefcase mr-1"></i>Workspace
                  </button>`
                  : ''
              }
            </div>
          </div>`
          )
          .join('');
        const teamSelect = document.getElementById('workspace-team');
        teamSelect.innerHTML =
          '<option value="">Choose team</option>' +
          teams.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
      } catch (e) {
        console.error(e);
      }
    }

    function showCreateTeamModal() {
      document.getElementById('create-team-modal').classList.remove('hidden');
    }

    async function createTeam(e) {
      e.preventDefault();
      const name = document.getElementById('team-name').value;
      try {
        const res = await fetch(`${API_BASE_URL}/api/teams`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${authToken}` },
          body: JSON.stringify({ name })
        });
        if (res.ok) {
          closeModal('create-team-modal');
          document.getElementById('team-name').value = '';
          loadTeams();
          showNotification('Team created');
        } else {
          const d = await res.json();
          showNotification(d.msg || 'Failed to create team');
        }
      } catch (e) {
        console.error(e);
      }
    }

    function showCreateWorkspaceModal() {
      document.getElementById('create-workspace-modal').classList.remove('hidden');
    }

    function showCreateWorkspaceModalFromTeam(teamId) {
      document.getElementById('create-workspace-modal').classList.remove('hidden');
      document.getElementById('workspace-team').value = teamId;
      loadWorkspaceTeamMembers();
    }

    async function loadWorkspaceTeamMembers() {
      const teamId = document.getElementById('workspace-team').value;
      if (!teamId) return;
      try {
        const res = await fetch(`${API_BASE_URL}/api/teams/${teamId}/members`, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        const members = await res.json();
        const container = document.getElementById('workspace-members-selection');
        container.innerHTML =
          '<label class="block text-gray-700 text-sm font-medium mb-2">Select Members</label>' +
          `<div class="space-y-2 max-h-40 overflow-y-auto border rounded p-2">
            ${members
              .map(
                m => `
              <label class="flex items-center space-x-2">
                <input type="checkbox" class="workspace-member-checkbox" value="${m.id}" ${
                  m.id === currentUser.id ? 'checked disabled' : ''
                }>
                <span>${m.name}</span>
              </label>`
              )
              .join('')}
          </div>`;
      } catch (e) {
        console.error(e);
      }
    }

    async function createWorkspace(e) {
      e.preventDefault();
      const name = document.getElementById('workspace-name').value;
      const team_id = document.getElementById('workspace-team').value;
      const members = Array.from(document.querySelectorAll('.workspace-member-checkbox:checked')).map(
        cb => cb.value
      );
      try {
        const res = await fetch(`${API_BASE_URL}/api/workspaces`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${authToken}` },
          body: JSON.stringify({ name, team_id, members })
        });
        if (res.ok) {
          closeModal('create-workspace-modal');
          document.getElementById('workspace-name').value = '';
          loadWorkspaces();
          showNotification('Workspace created');
        } else {
          const d = await res.json();
          showNotification(d.msg || 'Failed to create workspace');
        }
      } catch (e) {
        console.error(e);
      }
    }

    async function loadWorkspaces() {
      try {
        const res = await fetch(`${API_BASE_URL}/api/workspaces`, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        const ws = await res.json();
        const list = document.getElementById('workspaces-list');
        list.innerHTML = ws
          .map(
            w => `
          <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="bg-purple-100 rounded-full p-3 mb-4 w-fit">
              <i class="fas fa-briefcase text-purple-600 text-2xl"></i>
            </div>
            <h3 class="text-xl font-semibold mb-2">${w.name}</h3>
            <p class="text-sm text-gray-600">${w.is_owner ? 'Owner' : 'Member'}</p>
          </div>`
          )
          .join('');
        populateWorkspaceSelects();
      } catch (e) {
        console.error(e);
      }
    }

    async function populateWorkspaceSelects() {
      try {
        const res = await fetch(`${API_BASE_URL}/api/workspaces`, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        const ws = await res.json();
        const ids = ['kanban-workspace-select', 'doc-workspace-select', 'files-workspace-select', 'chat-workspace-select'];
        ids.forEach(id => {
          const sel = document.getElementById(id);
          sel.innerHTML =
            '<option value="">Select Workspace</option>' +
            ws.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
        });
      } catch (e) {
        console.error(e);
      }
    }

    async function loadKanban() {
      const wid = document.getElementById('kanban-workspace-select').value;
      if (!wid) return;
      currentWorkspaceId = wid;
      socket.emit('join_workspace', { workspace_id: wid, user_name: currentUser.name });
      try {
        const res = await fetch(`${API_BASE_URL}/api/kanban/${wid}`, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        if (res.status === 403) {
          showNotification('Access denied');
          return;
        }
        const data = await res.json();
        const board = document.getElementById('kanban-board');
        board.innerHTML = data.columns
          .map(
            (col, ci) => `
          <div class="kanban-column bg-gray-100 rounded-lg p-4 min-w-[300px]" ondrop="dropTask(event, ${ci})" ondragover="allowDrop(event)">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-semibold text-lg">${col.name}</h3>
              <button onclick="addTask(${ci})" class="text-indigo-600"><i class="fas fa-plus"></i></button>
            </div>
            <div class="space-y-3">
              ${(col.tasks || [])
                .map(
                  (t, ti) => `
                <div class="task-card bg-white rounded-lg p-4 shadow relative group" draggable="true" ondragstart="dragTask(event, ${ci}, ${ti})">
                  <div class="absolute top-2 right-2 hidden group-hover:flex space-x-1">
                    <button onclick='openEditTaskModal("${wid}", ${ci}, ${ti}, ${JSON.stringify(t)})' class="text-blue-600"><i class="fas fa-edit"></i></button>
                    <button onclick="deleteTask('${wid}', ${ci}, ${ti})" class="text-red-600"><i class="fas fa-trash"></i></button>
                  </div>
                  <h4 class="font-semibold mb-2 pr-12">${t.title}</h4>
                  <p class="text-sm text-gray-600 mb-3">${t.desc || ''}</p>
                  ${t.assigned_to ? '<p class="text-xs text-purple-600"><i class="fas fa-user"></i> Assigned</p>' : ''}
                  <div class="flex justify-between mt-2">
                    <button onclick="openTaskComments('${wid}', ${ci}, ${ti}, '${t.title.replace(/'/g, "\\'")}')" class="text-sm text-indigo-600">
                      <i class="fas fa-comment"></i> Comments
                    </button>
                    <button onclick="openAssignTask('${wid}', ${ci}, ${ti})" class="text-sm text-purple-600">
                      <i class="fas fa-user-plus"></i> Assign
                    </button>
                  </div>
                </div>`
                )
                .join('')}
            </div>
          </div>`
          )
          .join('');
      } catch (e) {
        console.error(e);
      }
    }

    async function addKanbanColumn() {
      const name = prompt('Column name:');
      if (!name) return;
      const wid = document.getElementById('kanban-workspace-select').value;
      if (!wid) return alert('Select workspace first');
      try {
        const res = await fetch(`${API_BASE_URL}/api/kanban/${wid}`, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        const data = await res.json();
        const cols = [...data.columns, { name, tasks: [] }];
        await saveKanban(cols);
      } catch (e) {
        console.error(e);
      }
    }

    async function addTask(ci) {
      const title = prompt('Task title:');
      if (!title) return;
      const desc = prompt('Task description:');
      const wid = document.getElementById('kanban-workspace-select').value;
      try {
        const res = await fetch(`${API_BASE_URL}/api/kanban/${wid}`, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        const data = await res.json();
        data.columns[ci].tasks.push({ title, desc });
        await saveKanban(data.columns);
      } catch (e) {
        console.error(e);
      }
    }

    async function saveKanban(columns) {
      const wid = document.getElementById('kanban-workspace-select').value;
      try {
        await fetch(`${API_BASE_URL}/api/kanban/${wid}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${authToken}` },
          body: JSON.stringify({ columns })
        });
        loadKanban();
        showNotification('Kanban updated');
      } catch (e) {
        console.error(e);
      }
    }

    function dragTask(e, ci, ti) {
      draggedTask = { ci, ti };
      e.target.classList.add('dragging');
    }
    function allowDrop(e) {
      e.preventDefault();
    }
    async function dropTask(e, targetCi) {
      e.preventDefault();
      if (!draggedTask) return;
      const wid = document.getElementById('kanban-workspace-select').value;
      try {
        const res = await fetch(`${API_BASE_URL}/api/kanban/${wid}`, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        const data = await res.json();
        const task = data.columns[draggedTask.ci].tasks[draggedTask.ti];
        data.columns[draggedTask.ci].tasks.splice(draggedTask.ti, 1);
        data.columns[targetCi].tasks.push(task);
        await saveKanban(data.columns);
        draggedTask = null;
      } catch (er) {
        console.error(er);
      }
    }

    function openEditTaskModal(wsId, colIdx, taskIdx, task) {
      currentTaskId = { wsId, colIdx, taskIdx };
      document.getElementById('edit-task-title').value = task.title;
      document.getElementById('edit-task-desc').value = task.desc || '';
      document.getElementById('edit-task-modal').classList.remove('hidden');
    }

    async function updateTask() {
      const { wsId, colIdx, taskIdx } = currentTaskId;
      const title = document.getElementById('edit-task-title').value;
      const desc = document.getElementById('edit-task-desc').value;
      try {
        await fetch(`${API_BASE_URL}/api/kanban/${wsId}/task/${colIdx}/${taskIdx}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${authToken}` },
          body: JSON.stringify({ title, desc })
        });
        closeModal('edit-task-modal');
        loadKanban();
        showNotification('Task updated');
      } catch (e) {
        console.error(e);
      }
    }

    async function deleteTask(wsId, colIdx, taskIdx) {
      if (!confirm('Delete task?')) return;
      try {
        await fetch(`${API_BASE_URL}/api/kanban/${wsId}/task/${colIdx}/${taskIdx}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${authToken}` }
        });
        loadKanban();
        showNotification('Task deleted');
      } catch (e) {
        console.error(e);
      }
    }

    function openTaskComments(wsId, colIdx, taskIdx, title) {
      currentTaskId = `${wsId}_${colIdx}_${taskIdx}`;
      document.getElementById('task-title-display').textContent = title;
      document.getElementById('task-comments-modal').classList.remove('hidden');
      loadTaskComments(currentTaskId);
      loadWorkspaceMembers(wsId);
    }

    async function loadTaskComments(tid) {
      const [wsId, colIdx, taskIdx] = tid.split('_');
      try {
        const res = await fetch(`${API_BASE_URL}/api/kanban/${wsId}/task/${colIdx}/${taskIdx}/comments`, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        const comments = await res.json();
        const list = document.getElementById('task-comments-list');
        list.innerHTML =
          comments
            .map(
              c => `
          <div class="border-b pb-3 mb-3">
            <div class="flex items-center space-x-2 mb-2">
              <div class="bg-indigo-600 text-white rounded-full h-8 w-8 flex items-center justify-center text-sm font-semibold">
                ${c.user_name.charAt(0)}
              </div>
              <div>
                <p class="font-semibold text-sm">${c.user_name}</p>
                <p class="text-xs text-gray-500">${new Date(c.created_at).toLocaleString()}</p>
              </div>
            </div>
            <p class="ml-10">${c.comment}</p>
          </div>`
            )
            .join('') || '<p class="text-center text-gray-500">No comments</p>';
      } catch (e) {
        console.error(e);
      }
    }

    async function addTaskComment() {
      const input = document.getElementById('comment-input');
      const comment = input.value.trim();
      if (!comment) return;
      const [wsId, colIdx, taskIdx] = currentTaskId.split('_');
      try {
        await fetch(`${API_BASE_URL}/api/kanban/${wsId}/task/${colIdx}/${taskIdx}/comments`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${authToken}` },
          body: JSON.stringify({ comment })
        });
        input.value = '';
        loadTaskComments(currentTaskId);
        showNotification('Comment added');
      } catch (e) {
        console.error(e);
      }
    }

    async function loadWorkspaceMembers(wsId) {
      try {
        const res = await fetch(`${API_BASE_URL}/api/workspaces/${wsId}/members`, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        workspaceMembers = await res.json();
      } catch (e) {
        console.error(e);
      }
    }

    function openAssignTask(wsId, colIdx, taskIdx) {
      currentTaskId = `${wsId}_${colIdx}_${taskIdx}`;
      loadWorkspaceMembers(wsId).then(() => {
        const sel = document.getElementById('assign-member-select');
        sel.innerHTML = workspaceMembers.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        document.getElementById('assign-task-modal').classList.remove('hidden');
      });
    }

    async function assignTask() {
      const userId = document.getElementById('assign-member-select').value;
      const [wsId, colIdx, taskIdx] = currentTaskId.split('_');
      try {
        await fetch(`${API_BASE_URL}/api/kanban/${wsId}/task/${colIdx}/${taskIdx}/assign`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${authToken}` },
          body: JSON.stringify({ user_id: userId })
        });
        closeModal('assign-task-modal');
        loadKanban();
        showNotification('Task assigned');
      } catch (e) {
        console.error(e);
      }
    }

    async function loadDocument() {
      const wid = document.getElementById('doc-workspace-select').value;
      if (!wid) return;
      currentWorkspaceId = wid;
      socket.emit('join_workspace', { workspace_id: wid, user_name: currentUser.name });
      try {
        const res = await fetch(`${API_BASE_URL}/api/docs/${wid}`, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        const data = await res.json();
        if (data.content && data.content !== '[]') quillEditor.setContents(JSON.parse(data.content));
        else quillEditor.setText('');
      } catch (e) {
        console.error(e);
      }
    }

    async function saveDocument() {
      const wid = document.getElementById('doc-workspace-select').value;
      if (!wid) return alert('Select workspace');
      const content = JSON.stringify(quillEditor.getContents());
      try {
        await fetch(`${API_BASE_URL}/api/docs/${wid}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${authToken}` },
          body: JSON.stringify({ content })
        });
        showNotification('Document saved');
      } catch (e) {
        console.error(e);
      }
    }

    async function loadFiles() {
      const wid = document.getElementById('files-workspace-select').value;
      if (!wid) return;
      currentWorkspaceId = wid;
      try {
        const res = await fetch(`${API_BASE_URL}/api/files/${wid}`, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        const files = await res.json();
        const list = document.getElementById('files-list');
        list.innerHTML = files
          .map(
            f => `
          <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="bg-blue-100 rounded-full p-3 mb-4 w-fit">
              <i class="fas fa-file text-blue-600 text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold mb-2 truncate" title="${f.name}">${f.name}</h3>
            <p class="text-xs text-gray-500 mb-3">v${f.version} • ${f.uploaded_by}</p>
            <div class="flex space-x-2">
              <a href="${f.url}" target="_blank" class="flex-1 text-center text-indigo-600 text-sm py-2 border border-indigo-600 rounded">View</a>
              <button onclick="viewFileVersions('${f.name}')" class="flex-1 text-center text-purple-600 text-sm py-2 border border-purple-600 rounded">Versions</button>
            </div>
          </div>`
          )
          .join('');
      } catch (e) {
        console.error(e);
      }
    }

    function showUploadModal() {
      document.getElementById('upload-file-modal').classList.remove('hidden');
    }

    async function uploadFile(e) {
      e.preventDefault();
      const wid = document.getElementById('files-workspace-select').value;
      if (!wid) return alert('Select workspace');
      const file = document.getElementById('file-input').files[0];
      if (!file) return;
      const fd = new FormData();
      fd.append('file', file);
      try {
        await fetch(`${API_BASE_URL}/api/files/${wid}`, {
          method: 'POST',
          headers: { Authorization: `Bearer ${authToken}` },
          body: fd
        });
        closeModal('upload-file-modal');
        document.getElementById('file-input').value = '';
        loadFiles();
        showNotification('File uploaded');
      } catch (e) {
        console.error(e);
      }
    }

    async function viewFileVersions(name) {
      const wid = document.getElementById('files-workspace-select').value;
      if (!wid) return;
      try {
        const res = await fetch(`${API_BASE_URL}/api/files/${wid}/versions/${encodeURIComponent(name)}`, {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        const versions = await res.json();
        document.getElementById('version-filename').textContent = name;
        const list = document.getElementById('versions-list');
        list.innerHTML = versions
          .map(
            v => `
          <div class="p-4 border rounded-lg mb-2 ${v.current ? 'bg-green-50' : ''}">
            <div class="flex justify-between items-center">
              <div>
                <p class="font-semibold">Version ${v.version} ${v.current ? '(Current)' : ''}</p>
                <p class="text-sm text-gray-600">${v.uploaded_by}</p>
                <p class="text-xs text-gray-500">${new Date(v.uploaded_at).toLocaleString()}</p>
              </div>
              <a href="${v.url}" target="_blank" class="px-4 py-2 bg-indigo-600 text-white rounded">Download</a>
            </div>
          </div>`
          )
          .join('');
        document.getElementById('file-versions-modal').classList.remove('hidden');
      } catch (e) {
        console.error(e);
      }
    }

    function joinWorkspaceChat() {
      const wid = document.getElementById('chat-workspace-select').value;
      if (!wid) return;
      currentWorkspaceId = wid;
      socket.emit('join_workspace', { workspace_id: wid, user_name: currentUser.name });
    }

    function sendChatMessage(e) {
      e.preventDefault();
      const msgInput = document.getElementById('chat-input');
      const msg = msgInput.value.trim();
      if (!msg || !currentWorkspaceId) return;
      socket.emit('chat_message', { workspace_id: currentWorkspaceId, user: currentUser.name, message: msg });
      msgInput.value = '';
    }

    function displayChatMessage(d) {
      const div = document.getElementById('chat-messages');
      const container = document.createElement('div');
      container.className = `mb-4 ${d.user === currentUser.name ? 'text-right' : ''}`;
      container.innerHTML = `
        <div class="inline-block ${
          d.user === currentUser.name ? 'bg-indigo-600 text-white' : 'bg-gray-200'
        } rounded-lg px-4 py-2 max-w-xs">
          <p class="font-semibold text-sm">${d.user}</p>
          <p>${d.message}</p>
          <p class="text-xs opacity-75 mt-1">${d.timestamp || ''}</p>
        </div>`;
      div.appendChild(container);
      div.scrollTop = div.scrollHeight;
    }

    function closeModal(id) {
      document.getElementById(id).classList.add('hidden');
    }

    function updateUIForRole() {
      const isAdmin = currentUser.role === 'admin';
      const nameEl = document.getElementById('user-name');
      nameEl.innerHTML = isAdmin
        ? `${currentUser.name} <span class="text-xs bg-yellow-500 text-white px-2 py-1 rounded ml-2">ADMIN</span>`
        : currentUser.name;
      if (!isAdmin) {
        const btn = document.getElementById('create-team-btn');
        if (btn) btn.style.display = 'none';
      }
    }
    </script>
  </body>
</html>
